---
title: "Cuneo Data Analysis"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. Each section of the code is then explained.

First of all import the libraries needed

```{r}
#install.packages(c("datavolley", "ovlytics"))
library(datavolley)
library(ggplot2)
library(dplyr)
library(ovlytics)
```

Import the file you are interested in considering more than one match, you have to import all the folder

```{r}
filename <- "C:/Users/mirko/Documents/GitHub/CuneoWebsite.io/Assets/Cuneo-Bergamo_cuneo.dvw"
#d <- dir("C:/Users/mirko/OneDrive - Politecnico di Milano/Altro/Volley/Conco2324/Parella Torino/Ritorno/", pattern = "dvw$", full.names = TRUE)
```

```{r}
teamName = 'HONDA OLIVERO S.BERNARDO CUNEO'
x <- dv_read(filename)
serve_idx <- find_serves(plays(x))
table(plays(x)$team[serve_idx])
```

Funzioni utili

```{r}
## find rows where a single player is on court
player_on_court <- function(x, target_player_id, team = NULL) {
  if (!is.null(team)) team <- match.arg(team, c("home", "visiting"))
  ## 'team' is optional here, if NULL then we look at both home and visiting teams
  idx <- rep(FALSE, nrow(x))
  if (is.null(team) || team == "home") {
    idx <- idx | x$home_player_id1 == target_player_id | x$home_player_id2 == target_player_id | x$home_player_id3 == target_player_id |
                 x$home_player_id4 == target_player_id | x$home_player_id5 == target_player_id | x$home_player_id6 == target_player_id
  }
  if (is.null(team) || team == "visiting") {
    idx <- idx | x$visiting_player_id1 == target_player_id | x$visiting_player_id2 == target_player_id | x$visiting_player_id3 == target_player_id |
                 x$visiting_player_id4 == target_player_id | x$visiting_player_id5 == target_player_id | x$visiting_player_id6 == target_player_id
  }
  idx[is.na(idx)] <- FALSE
  idx
}

## find rows where any of our target players are on court
any_player_on_court <- function(x, target_player_ids, team = NULL) {
  ## for each target player, find rows where they are on court
  out <- lapply(target_player_ids, function(pid) player_on_court(x, target_player_id = pid, team = team))
  ## and now find rows where ANY of those players were on court
  apply(do.call(cbind, out), 1, any)
}

## find rows where all of our target players are on court
all_players_on_court <- function(x, target_player_ids, team = NULL) {
  ## for each target player, find rows where they are on court
  out <- lapply(target_player_ids, function(pid) player_on_court(x, target_player_id = pid, team = team))
  ## and now find rows where ALL of those players were on court
  apply(do.call(cbind, out), 1, all)
}

```

```{r}
d <- dir("C:/Users/mirko/Documents/GitHub/CuneoWebsite.io/Assets/", pattern = "dvw$", full.names = TRUE)
lx <- list()
## read each file
for (fi in seq_along(d)) lx[[fi]] <- dv_read(d[fi], insert_technical_timeouts = FALSE)
## now extract the play-by-play component from each and bind them together
px <- list()
for (fi in seq_along(lx)) px[[fi]] <- plays(lx[[fi]])
px <- do.call(rbind, px)

```

## Rendimento in Battuta

```{r}
#, end_zone == 5
table_data <- px %>% 
  dplyr::filter(skill == "Serve", team == teamName) %>% 
  group_by(player_name) %>% 
  dplyr::summarize(
    N_battute = n(),
    count_perfette = sum(evaluation_code == "#", na.rm = TRUE),
    count_positive = sum(evaluation_code == "+", na.rm = TRUE),
    #count_escalamative = sum(evaluation_code == "!", na.rm = TRUE),
    #count_negative = sum(evaluation_code == "-", na.rm = TRUE),
    count_errori = sum(evaluation_code == "=", na.rm = TRUE),
    positività = (count_positive + count_perfette)/N_battute,
    efficienza = (count_positive + count_perfette - count_errori)/N_battute,
  )

table_data
```

```{r}
# Calculate cumulative statistics for the team
team_total <- table_data %>%
  summarise(
    N_battute = sum(N_battute),
    count_perfette = sum(count_perfette),
    count_positive = sum(count_positive),
    count_errori = sum(count_errori),
    positività = sum(count_positive + count_perfette) / sum(N_battute),
    efficienza = sum(count_positive + count_perfette - count_errori) / sum(N_battute)
  ) %>%
  mutate(player_name = "TOT. Squadra")  # Add a player_name for the team total row

# Combine the team total row with the original table data
table_data_with_total <- bind_rows(table_data, team_total)

# Print the table with the team total row
table_data_with_total
```

```{r}
library(kableExtra)

# Apply custom CSS styling to the entire table
# Reorder columns to make positività the second column
table_data <- table_data_with_total %>%
  #select(-efficienza) %>%
  select(1, 7, everything())

# Apply custom CSS styling to the entire table
styled_table <- table_data %>%
  kable("html") %>%
  kable_styling(full_width = FALSE, htmltable_class = 'styled-table', html_font = '"Be Vietnam Pro", sans-serif') %>%
  row_spec(9, bold = TRUE) %>%
  column_spec(2, background = ifelse(table_data$efficienza >= 0.3, "lightgreen",ifelse(table_data$efficienza > 0.25 & table_data$efficienza < 0.3, "yellow", "lightcoral")))

  #row_spec(which(table_data$efficienza > 0.2 & table_data$efficienza < 0.3), background = "yellow") %>%
  #row_spec(which(table_data$efficienza <= 0.2), background = "lightcoral")

# Save the styled table to an HTML file
writeLines(as.character(styled_table), "Battuta_tab.html")

```

```{r}
library(plotly)

fig <- plot_ly(table_data, 
               x = ~positività, 
               y = ~efficienza,
               type = 'scatter', 
               mode = 'markers', 
               hovertemplate = paste('<i>Player</i>: %{text}',
                                     '<br><b>Positività</b>: %{x}',
                                     '<br><b>Efficienza</b>: %{y}',
                                     '<br><b>Battuta</b>: %{marker.size}<extra></extra>'),
               color = ~positività,
               marker = list(size = ~N_battute, sizemode = "area", sizeref = 0.005, opacity = 0.5),
               text = ~player_name
)

fig <- fig %>% layout(title = 'Qualità Battuta',
                      xaxis = list(title = 'Positività', showgrid = TRUE),
                      yaxis = list(title = 'Efficienza', showgrid = TRUE)
)

fig
```

```{r}
library(htmlwidgets)

# Assuming 'fig' is your Plotly figure
saveWidget(fig, "Battuta.html")
```

## Rendimento in Ricezione

Ora analizziamo la ricezione:

```{r}
#, end_zone == 5
table_data <- px %>% 
  dplyr::filter(skill == "Reception", team == teamName) %>% 
  group_by(player_name) %>% 
  dplyr::summarize(
    N_receptions = n(),
    count_perfette = sum(evaluation_code == "#", na.rm = TRUE),
    count_positive = sum(evaluation_code == "+", na.rm = TRUE),
    #count_escalamative = sum(evaluation_code == "!", na.rm = TRUE),
    #count_negative = sum(evaluation_code == "-", na.rm = TRUE),
    count_errori = sum(evaluation_code == "=", na.rm = TRUE),
    positività = (count_positive + count_perfette)/N_receptions,
    efficienza = (count_positive + count_perfette - count_errori)/N_receptions,
  )

table_data
```

```{r}
# Compute total statistics for the team
total_stats <- table_data %>%
  summarise(
    N_receptions = sum(N_receptions),
    count_perfette = sum(count_perfette),
    count_positive = sum(count_positive),
    count_errori = sum(count_errori),
    positività = sum(count_positive + count_perfette) / sum(N_receptions),
    efficienza = sum(count_positive + count_perfette - count_errori) / sum(N_receptions)
  ) %>%
  mutate(player_name = "TOT. Squadra")  # Add a player_name for the team total row

# Combine the team total row with the original table data
table_data_with_total <- bind_rows(table_data, total_stats)

# Print the table with the team total row
table_data_with_total
```

```{r}
table_data <- table_data_with_total %>%
  #select(-efficienza) %>%
  select(1, 7, everything())

# Apply custom CSS styling to the entire table
styled_table <- table_data %>%
  kable("html") %>%
  kable_styling(full_width = FALSE, htmltable_class = 'styled-table', html_font = '"Be Vietnam Pro", sans-serif') %>%
  column_spec(2, 
              background = ifelse(
                table_data$player_name == "Serena Scognamillo", 
                ifelse(table_data$efficienza >= 0.56, "lightgreen", ifelse(table_data$efficienza > 0.48 & table_data$efficienza < 0.56, "yellow", "lightcoral")),
                ifelse(table_data$efficienza >= 0.42, "lightgreen", ifelse(table_data$efficienza > 0.41 & table_data$efficienza < 0.42, "orange", "red"))
                )
              )

# Save the styled table to an HTML file
writeLines(as.character(styled_table), "Ricezione_tab.html")
```

```{r}
fig <- plot_ly(table_data, 
               x = ~positività, 
               y = ~efficienza,
               type = 'scatter', 
               mode = 'markers', 
               hovertemplate = paste('<i>Player</i>: %{text}',
                                     '<br><b>Positività</b>: %{x}',
                                     '<br><b>Efficienza</b>: %{y}',
                                     '<br><b>Ricezione</b>: %{marker.size}<extra></extra>'),
               color = ~positività,
               marker = list(size = ~N_receptions, sizemode = "area", sizeref = 0.005, opacity = 0.5),
               text = ~player_name
)

fig <- fig %>% layout(title = 'Qualità Ricezione',
                      xaxis = list(title = 'Positività', showgrid = TRUE),
                      yaxis = list(title = 'Efficienza', showgrid = TRUE)
)
fig
```

```{r}
saveWidget(fig, "Ricezione.html")
```

## Rendimento in Attacco

```{r}
#  end_zone == 5
table_data <- px %>% 
  dplyr::filter(skill == "Attack", team == teamName) %>% 
  group_by(player_name) %>% 
  dplyr::summarize(
    N_attacks = n(),
    count_perfette = sum(evaluation_code == "#", na.rm = TRUE),
    count_positive = sum(evaluation_code == "+", na.rm = TRUE),
    #count_escalamative = sum(evaluation_code == "!", na.rm = TRUE),
    #count_negative = sum(evaluation_code == "-", na.rm = TRUE),
    count_errori = sum(evaluation_code == "=", na.rm = TRUE),
    positività = (count_positive + count_perfette)/N_attacks,
    efficienza = (count_positive + count_perfette - count_errori)/N_attacks,
  )

table_data
```

```{r}
table_data <- table_data %>%
  #select(-efficienza) %>%
  select(1, 7, everything())

# Apply custom CSS styling to the entire table
styled_table <- table_data %>%
  kable("html") %>%
  kable_styling(full_width = FALSE, htmltable_class = 'styled-table', html_font = '"Be Vietnam Pro", sans-serif') %>%
  column_spec(2, background = ifelse(table_data$efficienza >= 0.3, "lightgreen",ifelse(table_data$efficienza > 0.2 & table_data$efficienza < 0.3, "yellow", "lightcoral")))

# Save the styled table to an HTML file
writeLines(as.character(styled_table), "Attacco_tab.html")
```

```{r}
fig <- plot_ly(table_data, 
               x = ~positività, 
               y = ~efficienza,
               type = 'scatter', 
               mode = 'markers', 
               hovertemplate = paste('<i>Player</i>: %{text}',
                                     '<br><b>Attacchi</b>: %{marker.size}<extra></extra>'),
               color = ~positività,
               marker = list(size = ~N_attacks, sizemode = "area", sizeref = 0.01, opacity = 0.5),
               text = ~player_name
)

fig <- fig %>% layout(title = 'Qualità Attacco',
                      xaxis = list(title = 'Positività', showgrid = FALSE),
                      yaxis = list(title = 'Efficienza', showgrid = FALSE)
)

fig
```

```{r}
saveWidget(fig, "Attacco.html")
```
